#!/usr//bin/perl

use bigint;

my @offs = (0,3,7,9,11,15,17,33,35,39,45);
my @l19 = (1,176377839,381468772192258129,390125285764888664734203691,374033672392630508524864795662961961,359448796707478853662201398479404356886186983,345681908391253482444700805766256890688374132702150281,332456409626323552089753008110920578989152425860059980776167267,319736046569415960553023346593909692027276993628971883863936977542620829,307502197883843189728145070683195306634715300572715148091618574821423047802111371,295736438538105920753848805101221518347169034846464241638380603304292532634709193160046357,284420866155234999231087007390392444099790919003942969485429344438762552097336795489845181754603195,273538254349547522259589180544472876860684075817857666308521432524590908173589166299381140508333672348231869,263072036883964825093321085743751624592085890795667877968046914722839766002860060188356044538992936620738346077533371,253006281532576453382590877761237615086708861593042289202522301490010243250555590112007735795468718567589774511008063937101981,243325665673703086779483164699776334863653761239608010895221752077059186635289648588694650419857894777881877451704872426644446631397547,234015452963882018736875664431930231575827140398694847657266616194101746493170926436132593907169134296767239208215341305209205413117620066366669);

my %cell;
my ($width,$modidx) = @ARGV;
@ARGV = glob("$width.$modidx/yx.*/cpu.*") if defined $modidx;
while(<>) {
  last if ($width,$modidx) = /\/start (\d+) (\d+)$/;
}
my $mod = 2**64-$offs[$modidx];
print "width $width idx $modidx mod $mod\n";

while(<>) {
  my ($yx,$size,$ax,$xsize) = /^(\S+) size (\d+) (avg|xsize) (\S+) mod \d+$/;
  next if $yx eq '(0,0)';
  $yx =~ s/\b(\d)\b/0\1/g;
  if ($xsize) {
    if ($ax ne 'xsize') {
      $xsize = 1;
    }
    $cell{$yx}->{size} += $size;
    $cell{$yx}->{xsize} += $xsize;
  }
  my ($newill,$needy,$legal,$yx) = /^newillegal (\d+) needy (\d+) legal (\d+) at (\S+)$/;
  if ($yx) {
    $yx =~ s/\b(\d)\b/0\1/g;
    $cell{$yx} //= {size=>0,xsize=>0,newill=>0,needy=>0,legal=>0,parts=>0};
    $cell{$yx}->{newill} = ($cell{$yx}->{newill} + $newill) % $mod;
    $cell{$yx}->{needy} = ($cell{$yx}->{needy} + $needy) % $mod;
    $cell{$yx}->{legal} = ($cell{$yx}->{legal} + $legal) % $mod;
    $cell{$yx}->{parts}++;
  }
}

my $prevnlstates = 1;
my $prevparts = 1;
for my $yx (sort keys %cell) {
  my $nlstates = $cell{$yx}->{needy}+$cell{$yx}->{legal};
  my $nstates = $cell{$yx}->{newill} + $nlstates;
  my $diff = abs(($nstates - 3*$prevnlstates) % $mod);
  print "parts changed from $prevparts to $cell{$yx}->{parts}\n" unless $prevparts == $cell{$yx}->{parts};
  # print "$yx newillegal $cell{$yx}->{newill} needy $cell{$yx}->{needy} legal $cell{$yx}->{legal}\n";
  print "$yx size $cell{$yx}->{size} xsize $cell{$yx}->{xsize} diff $diff\n";
  $prevnlstates = $nlstates;
  $prevparts = $cell{$yx}->{parts};
}
print "\n";;
for my $yx (sort grep { /,00/ } keys %cell) {
  my ($y) = $yx =~ /(\d+),/;
  $diff = abs($cell{$yx}->{legal} % $mod - $l19[$y]%$mod);
  print "$yx legal $cell{$yx}->{legal} diff $diff\n";
}
