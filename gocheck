#!/usr//bin/perl

use bigint;

my @offs = (0,3,5,7,9,11,15,17,33,35,39,45,47,53,57,59,63,75,77,83);
my %legals = (
2 => [1,5,57,489,4125,35117],
3 => [1,15,489,12675,321689],
19 => [1,176377839,381468772192258129,390125285764888664734203691,374033672392630508524864795662961961,359448796707478853662201398479404356886186983,345681908391253482444700805766256890688374132702150281,332456409626323552089753008110920578989152425860059980776167267,319736046569415960553023346593909692027276993628971883863936977542620829,307502197883843189728145070683195306634715300572715148091618574821423047802111371,295736438538105920753848805101221518347169034846464241638380603304292532634709193160046357,284420866155234999231087007390392444099790919003942969485429344438762552097336795489845181754603195,273538254349547522259589180544472876860684075817857666308521432524590908173589166299381140508333672348231869,263072036883964825093321085743751624592085890795667877968046914722839766002860060188356044538992936620738346077533371,253006281532576453382590877761237615086708861593042289202522301490010243250555590112007735795468718567589774511008063937101981,243325665673703086779483164699776334863653761239608010895221752077059186635289648588694650419857894777881877451704872426644446631397547,234015452963882018736875664431930231575827140398694847657266616194101746493170926436132593907169134296767239208215341305209205413117620066366669]
);
my %sizes = (
'(00,01)'=>'2','(00,02)'=>5,'(00,03)'=>14,'(00,04)'=>41,'(00,05)'=>122,'(00,06)'=>365,'(00,07)'=>1094,'(00,08)'=>3281,'(00,09)'=>9842,'(00,10)'=>29525,'(00,11)'=>88574,'(00,12)'=>265721,'(00,13)'=>797162,'(00,14)'=>2391485,'(00,15)'=>7174454,'(00,16)'=>21523361,'(00,17)'=>64570082,'(00,18)'=>193710245,
'(01,00)'=>581130734,'(01,01)'=>968551224,'(01,02)'=>1248354915,'(01,03)'=>1549681979,'(01,04)'=>1872532447,'(01,05)'=>2247198571,'(01,06)'=>2687763949,'(01,07)'=>3209021823,'(01,08)'=>3829725502,'(01,09)'=>4570570769,'(01,10)'=>5455611910,'(01,11)'=>6513369915,'(01,12)'=>7778250701,'(01,13)'=>9293295015,'(01,14)'=>11117241273,'(01,15)'=>13346673297,'(01,16)'=>16191686752,'(01,17)'=>20242633946,'(01,18)'=>27420640118,
'(02,00)'=>21522651307,'(02,01)'=>30986308034,'(02,02)'=>31298623903,'(02,03)'=>31693832491,'(02,04)'=>32408870046,'(02,05)'=>33278325617,'(02,06)'=>34338606328,'(02,07)'=>35581728837,'(02,08)'=>37004817149,'(02,09)'=>38608152181,'(02,10)'=>40386888039,'(02,11)'=>42334433531,'(02,12)'=>44442197991,'(02,13)'=>46701574497,'(02,14)'=>49105278599,'(02,15)'=>51605344588,'(02,16)'=>54143854082,'(02,17)'=>57213368302,'(02,18)'=>61228340733,
'(03,00)'=>40881769487,'(03,01)'=>58002999560,'(03,02)'=>59334643238,'(03,03)'=>60469963159,'(03,04)'=>63341146488,'(03,05)'=>66835578587,'(03,06)'=>70817218968,'(03,07)'=>75287241359,'(03,08)'=>80230806554,'(03,09)'=>85648500896,'(03,10)'=>91526942570,'(03,11)'=>97839307034,'(03,12)'=>104532220425,'(03,13)'=>111512278630,'(03,14)'=>118534637438,'(03,15)'=>125343428114,'(03,16)'=>132606308733,'(03,17)'=>136916149852,'(03,18)'=>141914020432,
'(04,00)'=>94749641144,'(04,01)'=>133279673599,'(04,02)'=>139475100234,'(04,03)'=>141337328283,'(04,04)'=>144710831678,'(04,05)'=>148463045197,'(04,06)'=>undef,'(04,07)'=>157891441076,'(04,08)'=>162699042295,'(04,09)'=>167714036302,'(04,10)'=>undef,'(04,11)'=>178512937536,'(04,12)'=>184220151924,'(04,13)'=>undef,'(04,14)'=>196151814939,'(04,15)'=>202360200132,'(04,16)'=>207474013378,'(04,17)'=>210314119474,'(04,18)'=>217081706879,
'(05,00)'=>148078845223,'(05,01)'=>207211638983,'(05,02)'=>216469548060,'(05,03)'=>217564698754,'(05,04)'=>219659383053,'(05,05)'=>222577472541,'(05,06)'=>227080995823,'(05,07)'=>231946491708,'(05,08)'=>236515540795,'(05,09)'=>240846330390,'(05,10)'=>245246997565,'(05,11)'=>249759484707,'(05,12)'=>254331499560,'(05,13)'=>259141957250,'(05,14)'=>264141066009,'(05,15)'=>267785483556,'(05,16)'=>270766140299,'(05,17)'=>272186263424,'(05,18)'=>279883445920,
'(06,00)'=>191634190512,'(06,01)'=>266418725693,'(06,02)'=>277107749242,'(06,03)'=>276997911020,'(06,04)'=>278305221847,'(06,05)'=>280377167219,'(06,06)'=>283085518412,'(06,07)'=>286113198756,'(06,08)'=>289386617588,'(06,09)'=>292416290300,'(06,10)'=>295283858296,'(06,11)'=>298149543291,'(06,12)'=>301273797588,'(06,13)'=>304572612860,'(06,14)'=>307391975927,'(06,15)'=>309400710943,'(06,16)'=>311317808475,'(06,17)'=>310340847804,'(06,18)'=>318806979276,
'(07,00)'=>218995042180,'(07,01)'=>303087104611,'(07,02)'=>314503969042,'(07,03)'=>313662246123,'(07,04)'=>314762981544,'(07,05)'=>undef,'(07,06)'=>undef,'(07,07)'=>318238137665,'(07,08)'=>320224501295,'(07,09)'=>322197332637,'(07,10)'=>324074981108,'(07,11)'=>325954949273,'(07,12)'=>327989551602,'(07,13)'=>329635377133,'(07,14)'=>330993451400,'(07,15)'=>331898195487,'(07,16)'=>332652460063,'(07,17)'=>331412227798,'(07,18)'=>340203429309,
'(08,00)'=>234124268177,'(08,01)'=>323226593080,'(08,02)'=>335060999417,'(08,03)'=>333697753413,'(08,04)'=>334471818410,'(08,05)'=>334752773774,'(08,06)'=>335208185740,'(08,07)'=>335929311404,'(08,08)'=>336795620285,'(08,09)'=>337789906500,'(08,10)'=>338993103472,'(08,11)'=>340193842537,'(08,12)'=>341208451150,'(08,13)'=>341940704916,'(08,14)'=>342543120534,'(08,15)'=>342538499086,'(08,16)'=>343188781762,'(08,17)'=>341751955128,'(08,18)'=>350679355757,
'(09,00)'=>241673515350,'(09,01)'=>333167061729,'(09,02)'=>345100285717,'(09,03)'=>343429348231,'(09,04)'=>344002347891,'(09,05)'=>344016002922,'(09,06)'=>344298982782,'(09,07)'=>344475408752,'(09,08)'=>344862133870,'(09,09)'=>345351284908,'(09,10)'=>346068565995,'(09,11)'=>346710855084,'(09,12)'=>347206796840
);

my %cell;
my ($width,$modidx, $pref) = @ARGV;
if (defined $modidx) {
  $pref //= '';
  @ARGV = glob("$width.$modidx/yx.$pref*/cpu.*")
} else {
  while(<>) {
    last if ($width,$modidx) = /\/start (\d+) (\d+)$/;
  }
}
my $mod = 2**64-$offs[$modidx];
print "width $width idx $modidx mod $mod\n";

while(<>) {
  my ($yx,$size,$ax,$xsize) = /^(\S+) size (\d+) (avg|xsize) (\S+) mod \d+$/;
  next if $yx eq '(0,0)';
  $yx =~ s/\b(\d)\b/0\1/g;
  if ($xsize) {
    if ($ax ne 'xsize') {
      $xsize = 1;
    }
    $cell{$yx}->{size} += $size;
    $cell{$yx}->{xsize} += $xsize;
  }
  my ($newill,$needy,$legal,$yx) = /^newillegal (\d+) needy (\d+) legal (\d+) at (\S+)$/;
  if ($yx) {
    $yx =~ s/\b(\d)\b/0\1/g;
    $cell{$yx} //= {size=>0,xsize=>0,newill=>0,needy=>0,legal=>0,parts=>0};
    $cell{$yx}->{newill} = ($cell{$yx}->{newill} + $newill) % $mod;
    $cell{$yx}->{needy} = ($cell{$yx}->{needy} + $needy) % $mod;
    $cell{$yx}->{legal} = ($cell{$yx}->{legal} + $legal) % $mod;
    $cell{$yx}->{parts}++;
  }
}

my $prevnlstates = 1;
my $prevparts = 1;
for my $yx (sort keys %cell) {
  next unless $cell{$yx}->{size};
  my $nlstates = $cell{$yx}->{needy}+$cell{$yx}->{legal};
  my $nstates = $cell{$yx}->{newill} + $nlstates;
  my $diff = abs(($nstates - 3*$prevnlstates) % $mod);
  print "parts changed from $prevparts to $cell{$yx}->{parts}\n" unless $prevparts == $cell{$yx}->{parts};
  # print "$yx newillegal $cell{$yx}->{newill} needy $cell{$yx}->{needy} legal $cell{$yx}->{legal}\n";
  my $cmpsize = defined($sizes{$yx}) && $sizes{$yx} ne $cell{$yx}->{size} ? "!=$sizes{$yx}" : '';
  print "$yx size $cell{$yx}->{size}$cmpsize xsize $cell{$yx}->{xsize} diff $diff\n";
  $prevnlstates = $nlstates;
  $prevparts = $cell{$yx}->{parts};
}
print "\n";;
for my $yx (sort grep { /,00/ } keys %cell) {
  my ($y) = $yx =~ /(\d+),/;
  my $lw = $legals{$width};
  $diff = defined($lw) && defined $lw->[$y] ? abs($cell{$yx}->{legal} % $mod - $lw->[$y]%$mod) : '?';
  print "$yx legal $cell{$yx}->{legal} diff $diff\n";
}
