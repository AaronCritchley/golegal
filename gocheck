#!/usr//bin/perl

use bigint;

my @offs = (0,3,5,7,9,11,15,17,33,35,39,45);
my @l19 = (1,176377839,381468772192258129,390125285764888664734203691,374033672392630508524864795662961961,359448796707478853662201398479404356886186983,345681908391253482444700805766256890688374132702150281,332456409626323552089753008110920578989152425860059980776167267,319736046569415960553023346593909692027276993628971883863936977542620829,307502197883843189728145070683195306634715300572715148091618574821423047802111371,295736438538105920753848805101221518347169034846464241638380603304292532634709193160046357,284420866155234999231087007390392444099790919003942969485429344438762552097336795489845181754603195,273538254349547522259589180544472876860684075817857666308521432524590908173589166299381140508333672348231869,263072036883964825093321085743751624592085890795667877968046914722839766002860060188356044538992936620738346077533371,253006281532576453382590877761237615086708861593042289202522301490010243250555590112007735795468718567589774511008063937101981,243325665673703086779483164699776334863653761239608010895221752077059186635289648588694650419857894777881877451704872426644446631397547,234015452963882018736875664431930231575827140398694847657266616194101746493170926436132593907169134296767239208215341305209205413117620066366669);
my %sizes = ('(00,01)'=>'2','(00,02)'=>5,'(00,03)'=>14,'(00,04)'=>41,'(00,05)'=>122,'(00,06)'=>365,'(00,07)'=>1094,'(00,08)'=>3281,'(00,09)'=>9842,'(00,10)'=>29525,'(00,11)'=>88574,'(00,12)'=>265721,'(00,13)'=>797162,'(00,14)'=>2391485,'(00,15)'=>7174454,'(00,16)'=>21523361,'(00,17)'=>64570082,'(00,18)'=>193710245,'(01,00)'=>581130734,'(01,01)'=>968551224,'(01,02)'=>1248354915,'(01,03)'=>1549681979,'(01,04)'=>1872532447,'(01,05)'=>2247198571,'(01,06)'=>2687763949,'(01,07)'=>3209021823,'(01,08)'=>3829725502,'(01,09)'=>4570570769,'(01,10)'=>5455611910,'(01,11)'=>6513369915,'(01,12)'=>7778250701,'(01,13)'=>9293295015,'(01,14)'=>11117241273,'(01,15)'=>13346673297,'(01,16)'=>16191686752,'(01,17)'=>20242633946,'(01,18)'=>27420640118,'(02,00)'=>21522651307,'(02,01)'=>30986308034,'(02,02)'=>31298623903,'(02,03)'=>31693832491,'(02,04)'=>32408870046,'(02,05)'=>33278325617,'(02,06)'=>34338606328,'(02,07)'=>35581728837,'(02,08)'=>37004817149,'(02,09)'=>38608152181,'(02,10)'=>40386888039,'(02,11)'=>42334433531,'(02,12)'=>44442197991,'(02,13)'=>46701574497,'(02,14)'=>49105278599,'(02,15)'=>51605344588,'(02,16)'=>54143854082,'(02,17)'=>57213368302,'(02,18)'=>61228340733,'(03,00)'=>40881769487,'(03,01)'=>58002999560,'(03,02)'=>59334643238,'(03,03)'=>60469963159,'(03,04)'=>63341146488,'(03,05)'=>66835578587,'(03,06)'=>70817218968,'(03,07)'=>75287241359,'(03,08)'=>80230806554,'(03,09)'=>85648500896,'(03,10)'=>91526942570,'(03,11)'=>97839307034,'(03,12)'=>104532220425,'(03,13)'=>111512278630,'(03,14)'=>118534637438,'(03,15)'=>125343428114,'(03,16)'=>132606308733,'(03,17)'=>136916149852,'(03,18)'=>141914020432,'(04,00)'=>94749641144,'(04,01)'=>133279673599);

my %cell;
my ($width,$modidx, $pref) = @ARGV;
if (defined $modidx) {
  $pref //= '';
  @ARGV = glob("$width.$modidx/yx.$pref*/cpu.*")
} else {
  while(<>) {
    last if ($width,$modidx) = /\/start (\d+) (\d+)$/;
  }
}
my $mod = 2**64-$offs[$modidx];
print "width $width idx $modidx mod $mod\n";

while(<>) {
  my ($yx,$size,$ax,$xsize) = /^(\S+) size (\d+) (avg|xsize) (\S+) mod \d+$/;
  next if $yx eq '(0,0)';
  $yx =~ s/\b(\d)\b/0\1/g;
  if ($xsize) {
    if ($ax ne 'xsize') {
      $xsize = 1;
    }
    $cell{$yx}->{size} += $size;
    $cell{$yx}->{xsize} += $xsize;
  }
  my ($newill,$needy,$legal,$yx) = /^newillegal (\d+) needy (\d+) legal (\d+) at (\S+)$/;
  if ($yx) {
    $yx =~ s/\b(\d)\b/0\1/g;
    $cell{$yx} //= {size=>0,xsize=>0,newill=>0,needy=>0,legal=>0,parts=>0};
    $cell{$yx}->{newill} = ($cell{$yx}->{newill} + $newill) % $mod;
    $cell{$yx}->{needy} = ($cell{$yx}->{needy} + $needy) % $mod;
    $cell{$yx}->{legal} = ($cell{$yx}->{legal} + $legal) % $mod;
    $cell{$yx}->{parts}++;
  }
}

my $prevnlstates = 1;
my $prevparts = 1;
for my $yx (sort keys %cell) {
  next unless $cell{$yx}->{size};
  my $nlstates = $cell{$yx}->{needy}+$cell{$yx}->{legal};
  my $nstates = $cell{$yx}->{newill} + $nlstates;
  my $diff = abs(($nstates - 3*$prevnlstates) % $mod);
  print "parts changed from $prevparts to $cell{$yx}->{parts}\n" unless $prevparts == $cell{$yx}->{parts};
  # print "$yx newillegal $cell{$yx}->{newill} needy $cell{$yx}->{needy} legal $cell{$yx}->{legal}\n";
  my $cmpsize = defined($sizes{$yx}) && $sizes{$yx} ne $cell{$yx}->{size} ? "!=$sizes{$yx}" : '';
  print "$yx size $cell{$yx}->{size}$cmpsize xsize $cell{$yx}->{xsize} diff $diff\n";
  $prevnlstates = $nlstates;
  $prevparts = $cell{$yx}->{parts};
}
print "\n";;
for my $yx (sort grep { /,00/ } keys %cell) {
  my ($y) = $yx =~ /(\d+),/;
  $diff = abs($cell{$yx}->{legal} % $mod - $l19[$y]%$mod);
  print "$yx legal $cell{$yx}->{legal} diff $diff\n";
}
